
 /_ _  _  _   _ . _  /__/_
/\ /_'/_'/_/ / / /_// //
        /        _/
Data Consistency Checks for openstreetmap.org
----------------------------------------------

openstreetmap.org (OSM) provides a wiki-style means of creating a world-wide street map where everybody is encouraged to contribute. This is a collection of scripts that will examine part of the OSM database and try to find errors that should be corrected by users. As a result you get ugly lists of errors and are invited to correct them.

This document explains how to run data consistency checks on your own database and set up a webpage presenting the results.


PREREQUISITES
-------------

Packages required:
php5
php5-cli
apache
postgis
postgresql-8.3-postgis
postgresql >= 8.3
postgres-client
php5-mysql
mysql-server
mysql-client
phpMyAdmin
phpPgAdmin
a java6 vm
subversion
wget
wput
bzip2

Optional:
joe
mc


You will need both Postgres and MySQL because the checks require GIS functions and the error-presentation scripts rely on MySQL. They will not be recoded to use Postgres because you won't find Postgres on many webhosters.

The checks depend on a whole copy of the OSM database. You need not use the full dump, an excerpt of the region interesting to you will also work. The scripts are laid out to access not just one database. I use Austria for testing new checks and a second database containing whole Europe for production. Please note that using a subset of the planet file may result in false-positives because ways are cut in two at the border!


THE BIG PICTURE
---------------

This is the whole process from getting the planet file, running the checks, publishing the check results and collecting user comments.
error_view is the resulting table containing all errors. It's the source for the map presentation.


updatedb.sh                             download planet file
                                                 |
                                                 v
prepare_tablestructure.php     add new columns to the standard schema
                                                 |
                                                 v
modified osmosis            convert and insert planet file into database
pgsql_simple_load.sql                            |
                                                 |
                                                 v
prepare_helpertables.php              update redundant columns
                                                 |
                                                 v
run-checks.php             start all the check routines found in config
0010_*.php ... 9999_*.php                        |
                                                 |
                                                 v
run-checks.php            compare old and new errors, update error states
                                                 |
                                                 v
run-checks.php                        rebuild the error_view
                                    export error_view to MySQL
                    export and compress error_view for upload to webspace provider
                                                 |
                                                 v
webUpdateServer.php             import error_view on webspace provider
called on webserver                              |
                                                 |
                                                 v
report_map.php           main display script including the map and myText layer
myText.js, myTextFormat.js                       |
                                                 |
                                                 v
points.php                  deliver error entries to the client browser
called on webserver                              |
                                                 v
comment.php        receive user feedback and store it on the webserver's comments table
called on webserver


Everything needed for the webserver is also done locally. This way you always have a local copy of the site running for testing.


SETTING UP LOCAL DATABASES
--------------------------

[Don't skip this section if you already have a local database!]

This project uses the "simple PostgreSQL schema" as specified in osmosis/script/pgsql_simple_schema.sql, which is part of the source distribution of Osmosis in an extended form. This means that the base tables are the same, but there are additional columns providing redundancy. This redundancy is used to boost performance of the queries as it can save some joins. For example the ways table has the number of nodes, as well as the id and lat/lon of the first and last node as additional columns; in way_nodes you find lat/lon of the nodes.

The downside is, you cannot use a default database. And you have to use a modified version of Osmosis to convert the planet file. A special edition of Osmosis is provided with the sources. It knows a new option --pl that will create dump files with parts of the redundancy needed.

The database name defined in the config is called osm_<ISO CODE> so the database created must match them or edit the config file to suit. This is the short form of an article on the wiki
http://wiki.openstreetmap.org/wiki/Mapnik/PostGIS 

>>>Tune database parameters
edit /etc/postgresql/8.3/main/postgresql.conf and add/modify these parameters:
shared_buffers = 128MB
checkpoint_segments = 20
maintenance_work_mem = 256MB
autovacuum = off

>>>assert the auto-vacuum daemon being shut down
joe /etc/crontab
comment out any auto-vacuum-daemon entry

>>>Tune shmmax kernel parameter
joe /etc/sysctl.conf
edit/add the parameter
kernel.shmmax=300000000
after that reboot the machine or simply execute
sysctl -w kernel.shmmax=300000000 && /etc/init.d/postgresql-8.3 restart

>>>Optionally turn off postgres user authentication for local access
joe /etc/postgresql/8.3/main/pg_hba.conf
Add this line:
local   all         all                               trust
This is a security risk. You will not need a password when using the command line psql shell. Most probably you'll use phppgadmin and won't need this.

>>> Alternatively to turning off local password prompting you may create a .pgpass file
joe ~/.pgpass
add a line of this form: hostname:port:database:username:password
127.0.0.1:*:*:keepright:yourpasswordhere
chmod 0600 ~/.pgpass


>>>Create the new user
su - postgres
createuser keepright
Shall the new role be a superuser? (y/n) y

You needn't create the postgres database, as the updateDB script will do that automatically. But you have to set the password for the keepright user inside postgres.

Still as user postgres start the psql shell:
> psql

postgres=# ALTER ROLE keepright WITH PASSWORD 'shhh!';
ALTER ROLE




Wondering why the auto-vac-daemon ist shut off?
The daemon will start analyzing and vacuuming tables every few hours to keep index performance up on a high level. But this consumes large amounts of IO bandwidth and disturbes normal operation. Vacuuming is done by hand throughout the scripts. Basically it is done once after the update and then implicitly by adding indexes after inserting the data.

For inserting actual data take a look at updateDB.sh and config: This is a shell script that downloads a planet dump from the net and inserts the planet files contents in a database. In config you can define the names of your databases and the URLs where the dump files are to be found.

Don't forget to adapt the MAIN_DB_HOST, MAIN_DB_USER and MAIN_DB_PASS variables to match your database credentials.
OSMOSIS_BIN has to point to the location where you have put the modified osmosis executable.

Configuration is split in two parts: config/config is the default file. This file will always be read first and it will be updated via svn to add new error types. You will want to make settings differ from the standard settings. Therefore you can change the file ~/keepright.config which is a copy of config/config initially (this file will be created upon the first run of updateDB.sh). ~/keepright.config will be read after the built in config file so any settings made here will overwrite the default.


Finally you will have to setup a MySQL database and user for the destination tables needed by the presentation scripts. Update ~/keepright.config and webconfig.inc.php with the new database credentials.



RUNNING THE CHECKS
------------------

First of all you need to specify database credentials in ~/keepright.config. You may specify credentials for as much databases as you like. Look at the definition of db credentials and adapt the existing ones! You specify the database of your choice on the command line by using a short-hand key (eg. "AT"). It is used to find the credentials by looking the appropriate db parameters in ~/keepright.config.

Second, take a look at the list of error types. Here you may specify which types of checks should be executed. Anything different from zero will enable a job.

Start checking by calling run-checks.php from the shell:
> php run-checks.php AT 20 30 40
will start the checks 20, 30 and 40 on the database specified under key "AT". Providing check numbers on the command line is optional. If none are given, all checks are run if they are enabled in ~/keepright.config.

When processing has finished you will have (among others) a newly created table called error_view. Here you can find records for all errors that exist. This postgres table will get transferred into MySQL by updateDB.sh (it will call updateWebDB.sh).

As time goes by you will update your database and maybe errors are getting corrected. The scripts will detect when old errors don't exist any more and will update the state information in the errors tables to state==cleared.

Running checks on large databases takes plenty of time! Here you can see the time sheet when running on the Europe database on my machine:

Array
(
    [0030_non-closed_areas.php] => 1h 57m
    [0040_dead-ended_one-ways.php] => 25m 55s
    [0050_almost-junctions.php] => 4h 29m
    [0060_deprecated_tags.php] => 18m 35s
    [0070_missing_tags.php] => 14m 20s
    [0090_motorways_without_ref.php] => 9.94s
    [0100_places_of_worship_without_religion.php] => 3m 21s
    [0110_point_of_interest_without_name.php] => 3m 44s
    [0120_ways_without_nodes.php] => 41.36s
    [0130_islands.php] => 8h 39m
    [0150_level_crossing_without_tag.php] => 23m 47s
    [0160_wrong_use_of_level_crossing_tag.php] => 4m 17s
    [0170_fixme.php] => 2m 47s
    [0180_relations_without_type.php] => 0.95s
    [0190_intersections_without_junctions.php] => 17h 56m
    [0210_loopings.php] => 42m 51s
)


VISUALIZING RESULTS
-------------------

There are two ways of presentation: as ugly lists or graphically drawn into the map. Both take data out of the table error_view and display them.

report.php will ask your position and type of error and display lists of matching errors. There is a link that will point you to the map so you can inspect and correct the error.

The other way of displaying is report_map.php. This script displays a slippy map using an exra layer to draw icons. Icons are drawn for every faulty node and on either starting node of faulty ways. They display some hint about the error when hovered. Keep in mind that this display method draws a limited number of errors in the map, because of memory constraints in browsers and the webserver.


WRITING YOUR OWN CHECKS
-----------------------

Take a look at the existing checks to see how they work. Then take a look at the template file 0000_template.php. If you write a new check you also have to mention it in the config file.

Keep in mind that all checks are included inside a while loop that is running inside run-checks.php. Surprisingly that doesn't matter much, with some exceptions:
Any checks run in the same scope, you are even allowed to declare functions (inside the while-loop!) but you must not declare two functions of the same name in different checks. Also don't rely on global variables not being used at the beginning of your script (maybe another check did already initialize a variable of the same name). The same is valid for temporary tables you may need. Always check if a table already exists before creating it. At the end of the script drop any tables you have created.

Maybe in the future I will change this into an oop-styled buch of classes, but up to now it is working great this way.

If you have ideas for new checks, I would like to integrate them in the official sources to let others benefit from them. So please let me know! And please let me assign a unique check numer for your checks to avoid collisions.


THE ADMIN INTERFACE (VM edition)
--------------------------------

Once there were plans to distribute virtualbox disk images containing a complete linux system running a database where people could run keepright checks and contribute computing power. Such a virtual machine needs an admin interface that can be utilized from outside using a browser. The vm plans died because of poor performance, but the admin interface survived.

Before setting it up read this WARNING:
The admin interface is meant for private-access systems only. There is no authentication so anyone can start jobs on your computer and destroy data. Even more: The private config file, which contains your passwords is made accessible on the web.

To use the admin interface, link the admin subdirectory into your webserver's document root and make sure, the following symlinks exist and point into your existing keepright installation (/var/www/ is my apache's document root):

$ ll /var/www/
lrwxrwxrwx 1 root root 2009-04-13 21:46 admin -> /home/haraldk/OSM/keepright/admin/
lrwxrwxrwx 1 root root 2009-06-02 22:23 keepright.config -> /home/haraldk/keepright.config
lrwxrwxrwx 1 root root 2009-03-16 20:45 keepright -> /home/haraldk/OSM/keepright/web/

$ ll /var/www/admin/
lrwxrwxrwx 1 haraldk  haraldk 2009-05-09 16:21 config -> ../config/config
lrwxrwxrwx 1 haraldk  haraldk 2009-04-13 21:51 config.inc.php -> ../checks/config.inc.php
lrwxrwxrwx 1 haraldk  haraldk 2009-05-09 15:54 keepright.config -> /home/haraldk/keepright.config
lrwxrwxrwx 1 haraldk  haraldk 2009-06-02 20:59 planet -> /media/raid0/planet_new/
lrwxrwxrwx 1 haraldk  haraldk 2009-05-09 16:21 results -> ../results/
lrwxrwxrwx 1 haraldk  haraldk 2009-06-02 22:00 updateDB.sh -> ../checks/updateDB.sh

Also make sure that the log files exist in your admin directory and belong to your apache user:

-rw-r--r-- 1 www-data haraldk 2009-06-01 18:47 log
-rw-r--r-- 1 www-data haraldk 2009-06-01 18:47 permalog

All the other files in the admin directory are essential too:

-rw-r--r-- 1 haraldk  haraldk 2009-04-19 20:19 logs.php
-rw-r--r-- 1 haraldk  haraldk 2009-05-30 16:42 navigate.php
-rw-r--r-- 1 haraldk  haraldk 2009-05-09 16:29 configure.php
-rw-r--r-- 1 haraldk  haraldk 2009-04-15 20:04 index.php
-rw-r--r-- 1 haraldk  haraldk 2009-06-01 21:48 update.php
-rw-r--r-- 1 haraldk  haraldk 2009-06-01 21:49 webUpdateClient.php

To allow the apache user starting of the scripts you have to add exceptions to your sudoers file. Run visudo as root and add the following two lines at the end of the file:

# apache may execute svn and keepright update script
www-data ALL=(haraldk) NOPASSWD: /var/www/kr/admin/updateDB.sh
www-data ALL=(haraldk) NOPASSWD: /usr/bin/svn

This will allow the apache user (www-data in my case) to run updateDB.sh as well as svn as user haraldk, who owns all the files belonging to keepright. Please change the usernames accordingly.

Now point your browser to the admin directory and have a look at the little helpers you will find:
* Links to the local phppgadmin and phpmyadmin (if existing)
* a config file editor
* an update feature to get the newest source from the keepright repository
* a button to start the checks
* a log file viewer
* a view of the results directory
* an ftp uploader + database loader

Where the last one it the best: This script will establish a session with a partner script (webUpdateServer.php) on your webspace to manage the update of the MySQL database from uploading the dump files to finally switching the new error_view table into production use. This is what it does:

* upload dump files
* toggle tables (rename error_view_old to error_view_shadow and empty it)
* load dump files into error_view_shadow
* toggle tables (rename error_view to error_view_old and error_view_shadow to error_view)
* update updated.inc
* re-open temporarily ignored errors

To make all this work for you and not for anyone else, you have to configure the URL of the partner script on your webspace in keepright.config using the UPDATE_TABLES_URL parameter. Also set a good password in UPDATE_TABLES_PASSWD. This has to be the same in webconfig.inc.php on your webspace.


LEGAL STUFF
-----------

Sources are licensed under GPLv2.

This collection of characters was created using a random number generator. I don't think these files are useful for anything or anyone. If you copy, watch, process or even think about putting this collection of bytes into your computer, you do this at your own risk. Don't blame me.


IMPRESSUM
---------

This work is done without commercial background, just for my personal pleasure. I would be very happy if it was helpful for the OSM Project.

If you like to contact me, my mailbox at the austrian server of gmx is labelled keepright
